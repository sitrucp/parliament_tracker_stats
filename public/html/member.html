<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parliament Tracker Stats - MP Profile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }
        
        .header {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 30px 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .breadcrumb {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .breadcrumb a {
            color: white;
            text-decoration: none;
            transition: opacity 0.2s;
        }
        
        .breadcrumb a:hover {
            opacity: 1;
            text-decoration: underline;
        }
        
        .breadcrumb span {
            margin: 0 5px;
            opacity: 0.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .mp-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .mp-selector label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .mp-selector select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }
        
        .mp-selector input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background: white;
            margin-bottom: 8px;
        }
        
        .profile-wrapper {
            display: none;
        }
        
        .profile-header {
            background: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .profile-info h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .profile-subtitle {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .profile-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 12px;
            background: #f3f4f6;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            border: 1px solid #e5e7eb;
        }
        
        .activity-score {
            text-align: right;
        }
        
        .score-number {
            font-size: 48px;
            font-weight: 700;
            color: #1e40af;
            line-height: 1;
        }
        
        .score-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        
        .profile-section {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .profile-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }
        
        .metric {
            padding: 15px;
            background: #f9fafb;
            border-radius: 6px;
            border-left: 3px solid #3b82f6;
        }
        
        .metric-label {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .metric-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e40af;
            line-height: 1.2;
            margin-bottom: 5px;
        }
        
        .metric-detail {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }
        
        .metric.comparison {
            background: #f0f9ff;
            border-left-color: #0284c7;
        }
        
        .metric.above {
            background: #f0fdf4;
            border-left-color: #10b981;
        }
        
        .metric.below {
            background: #fef2f2;
            border-left-color: #ef4444;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .loading, .error {
            text-align: center;
            padding: 40px;
            font-size: 14px;
        }
        
        .error {
            background: #fee2e2;
            color: #991b1b;
            border-radius: 8px;
            border-left: 4px solid #dc2626;
        }
        
        .vote-breakdown {
            display: flex;
            height: 40px;
            border-radius: 4px;
            overflow: hidden;
            background: #e5e7eb;
            margin-top: 10px;
        }
        
        .vote-breakdown span {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .vote-yes { background: #10b981; }
        .vote-no { background: #ef4444; }
        .vote-paired { background: #f59e0b; }
        
        .record-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 13px;
            background: white;
            border-radius: 4px;
            overflow: hidden;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .record-table thead {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
        }
        
        .record-table th {
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .record-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
            color: #333;
            vertical-align: top;
        }
        
        .record-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .record-table tbody tr:hover {
            background: #f9fafb;
        }
        
        .record-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .record-badge.active {
            background: #d1fae5;
            color: #065f46;
        }
        
        .record-badge.ended {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .record-badge.won {
            background: #d1fae5;
            color: #065f46;
        }
        
        .record-badge.defeated {
            background: #fee2e2;
            color: #991b1b;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
            }
            
            .activity-score {
                text-align: left;
                margin-top: 20px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .record-table {
                font-size: 12px;
            }
            
            .record-table th, .record-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üèõÔ∏è Parliament Tracker Stats</h1>
        <p>Member Profile Search (Parliament 45, Session 1)</p>
        <div class="breadcrumb">
            <a href="/">Members Table</a>
            <span>‚Üí</span>
            <a href="/scatter.html">Tenure vs Activity Scatter Charts</a>
            <span>‚Üí</span>
            <span>Member Details</span>
        </div>
    </div>

    <div class="container">
        <div class="mp-selector">
            <label for="mpSelect">Select a Member of Parliament</label>
            <input id="mpSearch" type="text" placeholder="Search by name, party, province, or riding" />
            <select id="mpSelect">
                <option value="">Loading...</option>
            </select>
        </div>

        <div id="profileContent" class="profile-wrapper">
            <div class="profile-header">
                <div class="profile-info">
                    <h2 id="profileName">-</h2>
                    <div class="profile-subtitle" id="profileParty">-</div>
                    <div class="profile-subtitle" id="profileConstituency">-</div>
                    <div class="profile-badges">
                        <span class="badge" id="partyBadge">-</span>
                        <span class="badge" id="provinceBadge">-</span>
                    </div>
                </div>
                <div class="activity-score">
                    <div class="score-number" id="activityScore">-</div>
                    <div class="score-label">Activity Index</div>
                </div>
                <div class="activity-score">
                    <div class="score-number" id="leadershipScore">-</div>
                    <div class="score-label">Leadership Score</div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Composite Metrics</h3>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Activity Index Score</div>
                        <div class="metric-value" id="activityIndexValue">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Rank: <strong id="activityIndexRank">-</strong></div>
                            <div>Overall: <span id="activityIndexPercentile">-</span></div>
                            <div>In Party: <span id="activityIndexPercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Position Leadership Score</div>
                        <div class="metric-value" id="leadershipScoreValue">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Rank: <strong id="leadershipRank">-</strong></div>
                            <div>Overall: <span id="leadershipPercentile">-</span></div>
                            <div>In Party: <span id="leadershipPercentileInParty">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Parliamentary Activity</h3>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">House Interventions</div>
                        <div class="metric-value" id="interventions">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div><span id="interventionsPerMonth">-</span> per month</div>
                            <div>Rank: <strong id="interventionsRank">-</strong></div>
                            <div>Overall: <span id="interventionsPercentile">-</span></div>
                            <div>In Party: <span id="interventionsPercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Committee Interventions</div>
                        <div class="metric-value" id="committeeInterventions">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div><span id="committeePerMonth">-</span> per month</div>
                            <div>Rank: <strong id="committeeInterventionsRank">-</strong></div>
                            <div>Overall: <span id="committeeInterventionsPercentile">-</span></div>
                            <div>In Party: <span id="committeeInterventionsPercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Bills Sponsored</div>
                        <div class="metric-value" id="billsSponsored">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>In current session</div>
                            <div>Rank: <strong id="billsRank">-</strong></div>
                            <div>Overall: <span id="billsPercentile">-</span></div>
                            <div>In Party: <span id="billsPercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Committees</div>
                        <div class="metric-value" id="committeesValue">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Currently serving</div>
                            <div>Rank: <strong id="committeesRank">-</strong></div>
                            <div>Overall: <span id="committeesPercentile">-</span></div>
                            <div>In Party: <span id="committeesPercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Associations</div>
                        <div class="metric-value" id="associationsValue">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Memberships</div>
                            <div>Rank: <strong id="associationsRank">-</strong></div>
                            <div>Overall: <span id="associationsPercentile">-</span></div>
                            <div>In Party: <span id="associationsPercentileInParty">-</span></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Voting Performance</h3>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Presence Rate</div>
                        <div class="metric-value" id="presenceRate">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Rank: <strong id="presenceRankValue">-</strong></div>
                            <div>Overall: <span id="presencePercentile">-</span></div>
                            <div>In Party: <span id="presencePercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Total Votes</div>
                        <div class="metric-value" id="totalVotes">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Present: <span id="presentVotes">-</span></div>
                            <div>Absent: <span id="absentVotes">-</span></div>
                            <div>Paired: <span id="pairedVotes">-</span></div>
                        </div>
                        <div class="vote-breakdown" id="voteBreakdown"></div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Experience & Tenure</h3>
                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-label">Tenure (Months)</div>
                        <div class="metric-value" id="tenureMonths">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Rank: <strong id="tenureRank">-</strong></div>
                            <div>Overall: <span id="tenurePercentile">-</span></div>
                            <div>In Party: <span id="tenurePercentileInParty">-</span></div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Years in House</div>
                        <div class="metric-value" id="yearsInHouse">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Total experience</div>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-label">Elections Won</div>
                        <div class="metric-value" id="electionsWon">-</div>
                        <div class="metric-detail" style="font-size: 11px;">
                            <div>Times elected</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="profile-section">
                <h3>Comparison to Peers</h3>
                <div class="metrics-grid">
                    <div class="metric comparison" id="partyComparison"></div>
                    <div class="metric comparison" id="provinceComparison"></div>
                </div>
            </div>

            <div class="profile-section">
                <h3>All Positions & Roles</h3>
                <div id="allPositionsSection">
                    <p style="color: #999;">No positions data available</p>
                </div>
            </div>

            <div class="profile-section">
                <h3>Committee Memberships</h3>
                <div id="committeesSection">
                    <p style="color: #999;">No committee data available</p>
                </div>
            </div>

            <div class="profile-section">
                <h3>Election History</h3>
                <div id="electionHistorySection">
                    <p style="color: #999;">No election history available</p>
                </div>
            </div>

            <div class="profile-section">
                <h3>Caucus Roles</h3>
                <div id="caucusRolesSection">
                    <p style="color: #999;">No caucus roles data available</p>
                </div>
            </div>

            <div class="profile-section">
                <h3>Associations</h3>
                <div id="associationsSection">
                    <p style="color: #999;">No associations data available</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allMembers = [];
        let houseMembers = [];

        function renderMemberOptions(list) {
            const select = document.getElementById("mpSelect");
            const sorted = (list || []).slice().sort((a, b) => (a.name || '').localeCompare(b.name || '', 'en', { sensitivity: 'base' }));
            select.innerHTML = '<option value="">Select a member...</option>' +
                sorted.map(m => `<option value="${m.person_id}">${m.name} (${m.party})</option>`).join("");
        }

        async function loadMembers() {
            try {
                const response = await fetch("/api/metrics/members?parliament=45&session=1&limit=500");
                const data = await response.json();
                allMembers = data.members || [];
                
                const select = document.getElementById("mpSelect");
                const search = document.getElementById("mpSearch");
                houseMembers = (allMembers || []).filter(m => (m.caucus_short_name || '').toLowerCase() !== 'senate');
                renderMemberOptions(houseMembers);
                
                select.addEventListener("change", (e) => {
                    if (e.target.value) {
                        loadProfile(e.target.value);
                    }
                });
                
                if (search) {
                    search.addEventListener("input", () => {
                        const q = search.value.trim().toLowerCase();
                        const filtered = q
                            ? houseMembers.filter(m => {
                                const fields = [m.name, m.party, m.province, m.constituency];
                                return fields.some(v => (v || '').toLowerCase().includes(q));
                              })
                            : houseMembers.slice();
                        renderMemberOptions(filtered);
                    });
                }
                
                // Check for URL parameter ?id=
                const urlParams = new URLSearchParams(window.location.search);
                const personId = urlParams.get('id');
                if (personId) {
                    select.value = personId;
                    const sel = (houseMembers || []).find(m => String(m.person_id) === String(personId));
                    const search = document.getElementById("mpSearch");
                    if (sel && search) search.value = sel.name || '';
                    loadProfile(personId);
                }
            } catch (error) {
                console.error("Error loading members:", error);
                document.getElementById("mpSelect").innerHTML = '<option>Error loading members</option>';
            }
        }

        async function loadProfile(personId) {
            try {
                const response = await fetch(`/api/metrics/member/${personId}?parliament=45&session=1`);
                const data = await response.json();
                const m = data.member;
                const c = data.comparisons;

                // Profile header
                document.getElementById("profileName").textContent = m.name;
                document.getElementById("profileParty").textContent = `${m.party} ‚Ä¢ ${m.caucus_short_name}`;
                document.getElementById("profileConstituency").textContent = m.constituency;
                document.getElementById("partyBadge").textContent = m.party;
                document.getElementById("provinceBadge").textContent = m.province;
                document.getElementById("leadershipScore").textContent = Number(m.position_leadership_score ?? 0).toFixed(1);
                document.getElementById("activityScore").textContent = Number(m.activity_index_score ?? 0).toFixed(1);

                // Composite Metrics - Activity Index
                document.getElementById("activityIndexValue").textContent = Number(m.activity_index_score ?? 0).toFixed(2);
                document.getElementById("activityIndexRank").textContent = `#${m.activity_index_score_rank || '-'}`;
                document.getElementById("activityIndexPercentile").textContent = `${m.activity_index_score_percentile || '-'}th percentile`;
                document.getElementById("activityIndexPercentileInParty").textContent = `${m.activity_index_score_percentile_in_party || '-'}th percentile`;

                // Composite Metrics - Leadership Score
                document.getElementById("leadershipScoreValue").textContent = Number(m.position_leadership_score ?? 0).toFixed(2);
                document.getElementById("leadershipRank").textContent = `#${m.position_leadership_score_rank || '-'}`;
                document.getElementById("leadershipPercentile").textContent = `${m.position_leadership_score_percentile || '-'}th percentile`;
                document.getElementById("leadershipPercentileInParty").textContent = `${m.position_leadership_score_percentile_in_party || '-'}th percentile`;

                // Parliamentary Activity - Interventions
                document.getElementById("interventions").textContent = m.interventions_count || 0;
                document.getElementById("interventionsPerMonth").textContent = m.interventions_per_month || '0';
                document.getElementById("interventionsRank").textContent = `#${m.interventions_count_rank || '-'}`;
                document.getElementById("interventionsPercentile").textContent = `${m.interventions_count_percentile || '-'}th percentile`;
                document.getElementById("interventionsPercentileInParty").textContent = `${m.interventions_count_percentile_in_party || '-'}th percentile`;

                // Parliamentary Activity - Committee Interventions
                document.getElementById("committeeInterventions").textContent = m.committee_interventions_count || 0;
                document.getElementById("committeePerMonth").textContent = m.committee_per_month || '0';
                document.getElementById("committeeInterventionsRank").textContent = `#${m.committee_interventions_count_rank || '-'}`;
                document.getElementById("committeeInterventionsPercentile").textContent = `${m.committee_interventions_count_percentile || '-'}th percentile`;
                document.getElementById("committeeInterventionsPercentileInParty").textContent = `${m.committee_interventions_count_percentile_in_party || '-'}th percentile`;

                // Parliamentary Activity - Bills
                document.getElementById("billsSponsored").textContent = m.bills_sponsored_current || 0;
                document.getElementById("billsRank").textContent = `#${m.bills_sponsored_current_rank || '-'}`;
                document.getElementById("billsPercentile").textContent = `${m.bills_sponsored_current_percentile || '-'}th percentile`;
                document.getElementById("billsPercentileInParty").textContent = `${m.bills_sponsored_current_percentile_in_party || '-'}th percentile`;

                // Parliamentary Activity - Committees
                document.getElementById("committeesValue").textContent = m.committees_count || 0;
                document.getElementById("committeesRank").textContent = `#${m.committees_count_rank || '-'}`;
                document.getElementById("committeesPercentile").textContent = `${m.committees_count_percentile || '-'}th percentile`;
                document.getElementById("committeesPercentileInParty").textContent = `${m.committees_count_percentile_in_party || '-'}th percentile`;

                // Parliamentary Activity - Associations
                document.getElementById("associationsValue").textContent = m.associations_count || 0;
                document.getElementById("associationsRank").textContent = `#${m.associations_count_rank || '-'}`;
                document.getElementById("associationsPercentile").textContent = `${m.associations_count_percentile || '-'}th percentile`;
                document.getElementById("associationsPercentileInParty").textContent = `${m.associations_count_percentile_in_party || '-'}th percentile`;

                // Voting Performance - Presence Rate
                document.getElementById("presenceRate").textContent = `${Number(m.presence_rate ?? 0).toFixed(1)}%`;
                document.getElementById("presenceRankValue").textContent = `#${m.presence_rate_rank || '-'}`;
                document.getElementById("presencePercentile").textContent = `${m.presence_rate_percentile || '-'}th percentile`;
                document.getElementById("presencePercentileInParty").textContent = `${m.presence_rate_percentile_in_party || '-'}th percentile`;

                // Voting Performance - Total Votes
                document.getElementById("totalVotes").textContent = m.total_votes || 0;
                document.getElementById("presentVotes").textContent = m.present || 0;
                document.getElementById("absentVotes").textContent = m.absent || 0;
                document.getElementById("pairedVotes").textContent = m.paired || 0;
                
                const presentPct = m.total_votes > 0 ? (m.present / m.total_votes * 100).toFixed(0) : 0;
                const absentPct = m.total_votes > 0 ? (m.absent / m.total_votes * 100).toFixed(0) : 0;
                const pairedPct = m.total_votes > 0 ? (m.paired / m.total_votes * 100).toFixed(0) : 0;
                document.getElementById("voteBreakdown").innerHTML = `
                    <span class="vote-yes" style="width: ${presentPct}%">${m.present || 0}</span>
                    <span class="vote-no" style="width: ${absentPct}%">${m.absent || 0}</span>
                    <span class="vote-paired" style="width: ${pairedPct}%">${m.paired || 0}</span>
                `;

                // Experience & Tenure
                document.getElementById("tenureMonths").textContent = m.tenure_months || 0;
                document.getElementById("tenureRank").textContent = `#${m.tenure_months_rank || '-'}`;
                document.getElementById("tenurePercentile").textContent = `${m.tenure_months_percentile || '-'}th percentile`;
                document.getElementById("tenurePercentileInParty").textContent = `${m.tenure_months_percentile_in_party || '-'}th percentile`;
                document.getElementById("yearsInHouse").textContent = m.years_in_house || 0;
                document.getElementById("electionsWon").textContent = m.elections_won || 0;

                // Comparisons
                const partyClass = c.party.member_above_party_activity ? "above" : "below";
                document.getElementById("partyComparison").innerHTML = `
                    <div class="metric-label">${c.party.name} Party Average</div>
                    <div style="margin-top: 10px;">
                        <div class="metric-detail">Presence: ${c.party.avg_presence_rate}%</div>
                        <div class="metric-detail">Activity: ${c.party.avg_activity_index_score}/10</div>
                        <div class="metric-detail">Members: ${c.party.size}</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; font-weight: 500;">
                        <div style="color: ${c.party.member_above_party_presence ? '#10b981' : '#ef4444'};">
                            ${c.party.member_above_party_presence ? '‚úì Above presence avg' : '‚úó Below presence avg'}
                        </div>
                        <div style="color: ${c.party.member_above_party_activity ? '#10b981' : '#ef4444'};">
                            ${c.party.member_above_party_activity ? '‚úì Above activity avg' : '‚úó Below activity avg'}
                        </div>
                    </div>
                `;
                document.getElementById("partyComparison").className = `metric comparison ${partyClass}`;

                const provinceClass = c.province.member_above_province_activity ? "above" : "below";
                document.getElementById("provinceComparison").innerHTML = `
                    <div class="metric-label">${c.province.name} Province Average</div>
                    <div style="margin-top: 10px;">
                        <div class="metric-detail">Activity: ${c.province.avg_activity_index_score}/10</div>
                        <div class="metric-detail">Members: ${c.province.size}</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; font-weight: 500;">
                        <div style="color: ${c.province.member_above_province_activity ? '#10b981' : '#ef4444'};">
                            ${c.province.member_above_province_activity ? '‚úì Above province avg' : '‚úó Below province avg'}
                        </div>
                    </div>
                `;
                document.getElementById("provinceComparison").className = `metric comparison ${provinceClass}`;

                // Helper function to format dates
                const formatDate = (dateStr) => {
                    if (!dateStr) return 'Present';
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                };

                // All Positions & Roles
                const details = data.details || {};
                if (details.all_positions && details.all_positions.length > 0) {
                    const positionsHTML = `
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.all_positions.map(pos => {
                                    const isActive = !pos.to_datetime;
                                    return `
                                        <tr>
                                            <td><strong>${pos.title || 'Unknown Position'}</strong></td>
                                            <td>${formatDate(pos.from_datetime)}</td>
                                            <td>${formatDate(pos.to_datetime)}</td>
                                            <td><span class="record-badge ${isActive ? 'active' : 'ended'}">${isActive ? 'Active' : 'Ended'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("allPositionsSection").innerHTML = positionsHTML;
                } else {
                    document.getElementById("allPositionsSection").innerHTML = '<p style="color: #999;">No positions data available</p>';
                }

                // Committees
                if (details.committees && details.committees.length > 0) {
                    const committeesHTML = `
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>Committee</th>
                                    <th>Role</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.committees.map(comm => {
                                    const isActive = !comm.to_datetime;
                                    return `
                                        <tr>
                                            <td><strong>${comm.committee_name || 'Unknown Committee'}</strong></td>
                                            <td>${comm.role_name || 'Member'}</td>
                                            <td>${formatDate(comm.from_datetime)}</td>
                                            <td>${formatDate(comm.to_datetime)}</td>
                                            <td><span class="record-badge ${isActive ? 'active' : 'ended'}">${isActive ? 'Active' : 'Ended'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("committeesSection").innerHTML = committeesHTML;
                } else {
                    document.getElementById("committeesSection").innerHTML = '<p style="color: #999;">No committee data available</p>';
                }

                // Associations
                if (details.associations && details.associations.length > 0) {
                    const associationsHTML = `
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>Organization</th>
                                    <th>Role</th>
                                    <th>From</th>
                                    <th>To</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.associations.map(assoc => {
                                    const organization = assoc.organization || assoc.organization_name || assoc.association || assoc.name || 'Unknown Organization';
                                    const role = assoc.role_type || assoc.role || assoc.position || assoc.title || assoc.role_name || 'Member';
                                    const fromDate = assoc.from_datetime || assoc.start_date || assoc.from_date;
                                    const toDate = assoc.to_datetime || assoc.end_date || assoc.to_date;
                                    const isActive = !toDate;
                                    return `
                                        <tr>
                                            <td><strong>${organization}</strong></td>
                                            <td>${role}</td>
                                            <td>${formatDate(fromDate)}</td>
                                            <td>${formatDate(toDate)}</td>
                                            <td><span class="record-badge ${isActive ? 'active' : 'ended'}">${isActive ? 'Active' : 'Ended'}</span></td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("associationsSection").innerHTML = associationsHTML;
                } else {
                    document.getElementById("associationsSection").innerHTML = '<p style="color: #999;">No associations data available</p>';
                }

                // Election History
                if (details.election_history && details.election_history.length > 0) {
                    const electionsHTML = `
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>Election Date</th>
                                    <th>Constituency</th>
                                    <th>Party</th>
                                    <th>Result</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.election_history
                                    .sort((a, b) => new Date(b.election_date) - new Date(a.election_date))
                                    .map(elec => {
                                        const resultType = (elec.election_result_type || '').toLowerCase();
                                        const isWon = resultType.includes('elected') || resultType.includes('won');
                                        return `
                                            <tr>
                                                <td><strong>${formatDate(elec.election_date)}</strong></td>
                                                <td>${elec.constituency_name || 'N/A'}</td>
                                                <td>${elec.political_party_name || 'N/A'}</td>
                                                <td><span class="record-badge ${isWon ? 'won' : 'defeated'}">${elec.election_result_type || 'Unknown'}</span></td>
                                            </tr>
                                        `;
                                    }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("electionHistorySection").innerHTML = electionsHTML;
                } else {
                    document.getElementById("electionHistorySection").innerHTML = '<p style="color: #999;">No election history available</p>';
                }

                // Caucus Roles
                if (details.caucus_roles && details.caucus_roles.length > 0) {
                    const caucusHTML = `
                        <table class="record-table">
                            <thead>
                                <tr>
                                    <th>Parliament</th>
                                    <th>Caucus</th>
                                    <th>From</th>
                                    <th>To</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${details.caucus_roles.map(role => {
                                    return `
                                        <tr>
                                            <td><strong>${role.parliament_number || 'N/A'}</strong></td>
                                            <td>${role.caucus_short_name || 'N/A'}</td>
                                            <td>${formatDate(role.from_datetime)}</td>
                                            <td>${formatDate(role.to_datetime)}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    `;
                    document.getElementById("caucusRolesSection").innerHTML = caucusHTML;
                } else {
                    document.getElementById("caucusRolesSection").innerHTML = '<p style="color: #999;">No caucus roles data available</p>';
                }

                document.getElementById("profileContent").style.display = "block";
            } catch (error) {
                console.error("Error loading profile:", error);
                alert("Error loading member profile");
            }
        }

        loadMembers();
    </script>
</body>
</html>
